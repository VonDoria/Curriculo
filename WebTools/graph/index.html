<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataPlotter</title>
    <link rel="icon" href="graphLogo.png">
    <meta name="theme-color" content="#f8fafc">
    
    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        /* --- ESTILOS DO TEMPLATE (PRESERVADOS) --- */
        
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            color: #334155; /* Slate-700 */
        }

        /* Classes Utilitárias de UI para Reuso */
        .card {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0; /* slate-200 */
            transition: all 0.3s ease;
        }

        .section-title {
            font-size: 1.125rem; /* text-lg */
            font-weight: 700;
            color: #1e293b; /* slate-800 */
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Inputs Padronizados */
        .input-std {
            width: 100%;
            padding: 0.625rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            outline: none;
            transition: all 0.2s;
            background-color: #fff;
        }
        .input-std:focus {
            border-color: #6366f1; /* Indigo-500 */
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
        }
        
        /* Input compacto para tabelas */
        .input-compact {
            padding: 0.4rem;
            font-size: 0.875rem;
        }

        /* Botões Padronizados */
        .btn {
            padding: 0.625rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
        }
        .btn-primary { background-color: #6366f1; color: white; }
        .btn-primary:hover { background-color: #4f46e5; transform: translateY(-1px); }
        
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-secondary:hover { background-color: #475569; transform: translateY(-1px); }

        .btn-success { background-color: #10b981; color: white; }
        .btn-success:hover { background-color: #059669; transform: translateY(-1px); }
        
        .btn-danger { background-color: #ef4444; color: white; }
        .btn-danger:hover { background-color: #dc2626; transform: translateY(-1px); }

        .btn-ghost { background-color: transparent; color: #64748b; }
        .btn-ghost:hover { background-color: #f1f5f9; color: #334155; }

        .btn-dashed {
            background-color: #f8fafc;
            border: 2px dashed #cbd5e1;
            color: #64748b;
        }
        .btn-dashed:hover {
            border-color: #6366f1;
            color: #6366f1;
            background-color: #eef2ff;
        }

        /* Navegação (Tabs) - Estilo Clean */
        .tabs-container {
            overflow-x: auto;
            scrollbar-width: none;
        }
        .tabs-container::-webkit-scrollbar { display: none; }
        
        .tab {
            padding: 1rem 0.75rem;
            border-bottom: 2px solid transparent;
            font-weight: 500;
            font-size: 0.875rem;
            color: #64748b;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
            transition: color 0.2s, border-color 0.2s;
            background: none;
            border-top: none; border-left: none; border-right: none;
        }
        .tab:hover { 
            color: #334155;
            border-bottom-color: #cbd5e1;
        }
        .tab.active {
            color: #6366f1;
            border-bottom-color: #6366f1;
        }
        .tab-content { 
            display: none; 
            opacity: 0; 
            transition: opacity 0.3s ease; 
        }
        .tab-content.active { 
            display: block; 
            opacity: 1; 
        }

        /* Elementos Específicos do DataPlotter (Estilizados para bater com o Template) */
        
        /* Dropdown de Cores */
        .color-select-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.5rem;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        .color-select-btn:hover { 
            border-color: #6366f1; 
        }
        
        .color-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            padding: 0.5rem;
            z-index: 50;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            width: max-content;
            margin-top: 0.25rem;
        }
        .color-option {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s;
        }
        .color-option:hover { transform: scale(1.1); }
        .color-option.selected { border-color: #334155; transform: scale(1.1); }

        /* Tutorial Accordion (Do template) */
        details summary { cursor: pointer; list-style: none; }
        details summary::-webkit-details-marker { display: none; }
        details summary .arrow { transition: transform 0.2s; }
        details[open] summary .arrow { transform: rotate(90deg); }
        .tutorial-step { transition: background-color 0.2s; }
        .tutorial-step:hover { background-color: #f8fafc; }

        /* Toggles */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #6366f1;
            transform: translateX(10px);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #6366f1;
        }

    </style>
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl min-h-screen flex flex-col">
        
        <!-- HEADER -->
        <header class="text-center mb-8 p-6 bg-white rounded-xl shadow-md border border-slate-200">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-800 flex items-center justify-center gap-3">
                <i class="ph-bold ph-chart-polar text-indigo-500"></i>
                <span id="app-title">DataPlotter</span>
            </h1>
            <p class="text-slate-500 mt-2">Crie gráficos científicos de forma rápida e intuitiva.</p>
        </header>

        <!-- NAVEGAÇÃO -->
        <div class="mb-6 border-b border-slate-200 tabs-container">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="tab active" data-tab="line-chart">
                    <i class="ph-bold ph-chart-line"></i> Gráfico de Linhas
                </button>
                <button class="tab" data-tab="bar-chart">
                    <i class="ph-bold ph-chart-bar"></i> Gráfico de Barras
                </button>
                <button class="tab" data-tab="tutorial">
                    <i class="ph-bold ph-book-open"></i> Tutorial
                </button>
                <button class="tab" data-tab="settings">
                    <i class="ph-bold ph-gear"></i> Configurações
                </button>
            </nav>
        </div>

        <main class="flex-grow">
            
            <!-- ABA GRÁFICO DE LINHAS -->
            <div id="line-chart-tab" class="tab-content active space-y-6">
                
                <!-- Área Visual do Gráfico -->
                <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="section-title mb-0"><i class="ph-bold ph-eye text-indigo-500"></i> Visualização</h2>
                        
                        <!-- Toggle de Preenchimento -->
                        <div class="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                            <div class="relative inline-block w-8 align-middle select-none">
                                <input type="checkbox" id="lineFillToggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-1 left-1" onchange="renderChart('line')"/>
                                <label for="lineFillToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                            </div>
                            <span class="text-xs font-semibold text-slate-600 uppercase">Preencher Área</span>
                        </div>
                    </div>
                    
                    <div class="h-[400px] w-full relative">
                        <canvas id="lineCanvas"></canvas>
                    </div>

                    <!-- Legenda de Área (Integral) -->
                    <div id="lineAreaLegend" class="mt-6 pt-4 border-t border-slate-100 hidden">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">Cálculo de Área (Integral)</p>
                        <div id="lineAreaLegendContent" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3 text-sm"></div>
                    </div>
                </div>

                <!-- Botão de Ação Principal -->
                <button onclick="renderChart('line')" class="btn btn-primary w-full shadow-lg shadow-indigo-200">
                    <i class="ph-bold ph-arrows-clockwise"></i> Atualizar Gráfico
                </button>

                <!-- Área de Datasets (Lista) -->
                <div class="space-y-4">
                    <h2 class="section-title"><i class="ph-bold ph-database text-indigo-500"></i> Dados</h2>
                    
                    <div id="lineDatasetsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Datasets injetados via JS -->
                    </div>

                    <button onclick="addDataset('line')" class="btn btn-dashed w-full py-4">
                        <i class="ph-bold ph-plus-circle text-xl"></i> Novo Conjunto de Dados
                    </button>
                </div>

                <!-- Biblioteca Local -->
                <div class="card bg-slate-50 border-slate-200">
                    <h2 class="section-title"><i class="ph-bold ph-floppy-disk text-slate-600"></i> Biblioteca Local</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500">Salvar Atual</label>
                            <div class="flex gap-2">
                                <input type="text" id="lineChartTitle" class="input-std" placeholder="Nome do gráfico...">
                                <button onclick="saveChart('line')" class="btn btn-secondary">Salvar</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500">Carregar Salvo</label>
                            <div class="flex gap-2">
                                <select id="lineSavedSelect" class="input-std">
                                    <option value="">Selecione...</option>
                                </select>
                                <button onclick="loadChart('line')" class="btn btn-primary">Carregar</button>
                                <button onclick="deleteSavedChart('line')" class="btn btn-danger px-3"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200 text-right">
                         <button onclick="clearAll('line')" class="text-xs text-red-500 hover:text-red-700 font-medium flex items-center justify-end gap-1 ml-auto">
                            <i class="ph-bold ph-trash"></i> Limpar Tela
                        </button>
                    </div>
                </div>

            </div>

            <!-- ABA GRÁFICO DE BARRAS -->
            <div id="bar-chart-tab" class="tab-content space-y-6">
                 <!-- Área Visual -->
                 <div class="card">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="section-title mb-0"><i class="ph-bold ph-eye text-emerald-500"></i> Visualização</h2>
                        
                        <div class="flex items-center gap-3 bg-slate-50 px-3 py-1.5 rounded-lg border border-slate-100">
                            <div class="relative inline-block w-8 align-middle select-none">
                                <input type="checkbox" id="barStackToggle" class="toggle-checkbox absolute block w-4 h-4 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-300 top-1 left-1" onchange="renderChart('bar')"/>
                                <label for="barStackToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                            </div>
                            <span class="text-xs font-semibold text-slate-600 uppercase">Empilhar</span>
                        </div>
                    </div>
                    
                    <div class="h-[400px] w-full relative">
                        <canvas id="barCanvas"></canvas>
                    </div>
                </div>

                <button onclick="renderChart('bar')" class="btn btn-success w-full shadow-lg shadow-emerald-200">
                    <i class="ph-bold ph-arrows-clockwise"></i> Atualizar Barras
                </button>

                 <!-- Área de Datasets -->
                 <div class="space-y-4">
                    <h2 class="section-title"><i class="ph-bold ph-database text-emerald-500"></i> Conjuntos de Barras</h2>
                    
                    <div id="barDatasetsList" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Datasets injetados via JS -->
                    </div>

                    <button onclick="addDataset('bar')" class="btn btn-dashed w-full py-4">
                        <i class="ph-bold ph-plus-circle text-xl"></i> Novo Conjunto de Barras
                    </button>
                </div>

                 <!-- Biblioteca Local -->
                 <div class="card bg-slate-50 border-slate-200">
                    <h2 class="section-title"><i class="ph-bold ph-floppy-disk text-slate-600"></i> Biblioteca Local</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500">Salvar Atual</label>
                            <div class="flex gap-2">
                                <input type="text" id="barChartTitle" class="input-std" placeholder="Nome do gráfico...">
                                <button onclick="saveChart('bar')" class="btn btn-secondary">Salvar</button>
                            </div>
                        </div>
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-500">Carregar Salvo</label>
                            <div class="flex gap-2">
                                <select id="barSavedSelect" class="input-std">
                                    <option value="">Selecione...</option>
                                </select>
                                <button onclick="loadChart('bar')" class="btn btn-primary">Carregar</button>
                                <button onclick="deleteSavedChart('bar')" class="btn btn-danger px-3"><i class="ph-bold ph-trash"></i></button>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 pt-4 border-t border-slate-200 text-right">
                         <button onclick="clearAll('bar')" class="text-xs text-red-500 hover:text-red-700 font-medium flex items-center justify-end gap-1 ml-auto">
                            <i class="ph-bold ph-trash"></i> Limpar Tela
                        </button>
                    </div>
                </div>
            </div>

            <!-- ABA TUTORIAL -->
            <div id="tutorial-tab" class="tab-content">
                <div class="card space-y-6">
                    <div>
                        <h2 class="section-title"><i class="ph-bold ph-graduation-cap text-indigo-500"></i> Como usar o DataPlotter</h2>
                        <p class="text-slate-600 mb-4">Bem-vindo! Esta ferramenta permite criar gráficos científicos e exportá-los. Siga os passos:</p>
                    </div>

                    <div class="space-y-3">
                        <details class="bg-slate-50 p-4 rounded-lg border border-slate-200 tutorial-step">
                            <summary class="font-semibold text-slate-800 flex justify-between items-center">
                                <span>1. Inserindo Dados</span>
                                <i class="ph ph-caret-right arrow text-slate-400"></i>
                            </summary>
                            <div class="pt-3 mt-3 border-t border-slate-200 text-slate-600 text-sm">
                                <p>Na aba do gráfico desejado, clique em "Novo Conjunto". Você pode digitar manualmente os dados na tabela ou ativar o modo "Exportar/Colar" para colar dados do Excel ou CSV. Se colar, clique em "Processar" para preencher a tabela.</p>
                            </div>
                        </details>

                        <details class="bg-slate-50 p-4 rounded-lg border border-slate-200 tutorial-step">
                            <summary class="font-semibold text-slate-800 flex justify-between items-center">
                                <span>2. Gerando o Gráfico</span>
                                <i class="ph ph-caret-right arrow text-slate-400"></i>
                            </summary>
                            <div class="pt-3 mt-3 border-t border-slate-200 text-slate-600 text-sm">
                                <p>Após inserir os dados, clique no botão grande "Atualizar Gráfico". O gráfico será renderizado na área superior. Use os controles (Preencher Área / Empilhar) para alterar a visualização.</p>
                            </div>
                        </details>

                        <details class="bg-slate-50 p-4 rounded-lg border border-slate-200 tutorial-step">
                            <summary class="font-semibold text-slate-800 flex justify-between items-center">
                                <span>3. Biblioteca Local</span>
                                <i class="ph ph-caret-right arrow text-slate-400"></i>
                            </summary>
                            <div class="pt-3 mt-3 border-t border-slate-200 text-slate-600 text-sm">
                                <p>Use a seção "Biblioteca Local" no final da página para salvar configurações de gráficos que você usa frequentemente. Os dados ficam salvos no seu navegador.</p>
                            </div>
                        </details>
                    </div>
                </div>
            </div>

            <!-- ABA CONFIGURAÇÕES (Backup) -->
            <div id="settings-tab" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

                    <div class="card bg-white p-6 rounded-xl shadow-md border border-slate-200">
                        <h2 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="ph-bold ph-arrows-left-right text-emerald-500"></i> Sincronização de Dados
                        </h2>
                        
                        <div class="space-y-4">
                            <!-- Área de Exportação -->
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Exportar (Backup)</label>
                                <button id="btnExport" class="btn btn-success w-full justify-center">
                                    <i class="ph-bold ph-export"></i> Copiar Dados para Transferência
                                </button>
                                <p class="text-xs text-slate-400 mt-1">Copia todo o estado da aplicação para a área de transferência.</p>
                            </div>
                            
                            <hr class="border-slate-100 my-2">

                            <!-- Área de Importação -->
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Importar (Restaurar)</label>
                                <textarea id="importArea" class="w-full h-24 p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-400 outline-none transition resize-none text-xs font-mono" placeholder="Cole aqui o código JSON..."></textarea>
                                <button id="btnImport" class="btn btn-secondary w-full mt-2 justify-center">
                                    <i class="ph-bold ph-download-simple"></i> Substituir e Importar
                                </button>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </main>

        <!-- Barra de Armazenamento -->
        <footer class="mt-8">
            <div class="bg-white p-3 rounded-xl shadow-md border border-slate-200">
                <div class="w-full bg-slate-200 rounded-full h-2.5 overflow-hidden">
                    <div id="storageProgress" class="bg-indigo-500 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
                <div class="flex justify-between text-xs text-slate-500 mt-2">
                    <span>Uso do Armazenamento Local</span>
                    <span id="storageText">0% (0 KB / 5 MB)</span>
                </div>
            </div>
        </footer>
        
        <!-- Container de Toasts -->
        <div id="toastContainer" class="fixed bottom-24 sm:bottom-5 left-5 w-full max-w-xs z-50 pointer-events-none"></div>

    </div>

    <script>
        /**
         * CONFIGURAÇÃO GLOBAL E UTILITÁRIOS
         */
        const APP_KEY = 'DataPlotter_V2_Store'; 
        const VIBRANT_COLORS = ['#6366f1', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const formatNum = (n) => new Intl.NumberFormat('pt-BR', { maximumFractionDigits: 2 }).format(n);

        // Estado Inicial
        const defaultState = {
            line: { datasets: [] },
            bar: { datasets: [] }
        };

        // Estado Reativo
        let appState = JSON.parse(JSON.stringify(defaultState));
        // Instâncias do Chart.js
        let chartInstances = { line: null, bar: null };

        // --- SISTEMA DE ARMAZENAMENTO ---

        function saveData() {
            try {
                const serialized = JSON.stringify(appState);
                localStorage.setItem(APP_KEY, serialized);
                updateStorageBar();
            } catch (e) {
                showToast('Erro ao salvar dados (Storage cheio?)', 'error');
            }
        }

        function loadData() {
            const raw = localStorage.getItem(APP_KEY);
            if (raw) {
                try {
                    const parsed = JSON.parse(raw);
                    
                    appState = { ...defaultState, ...parsed };
                    
                    ['line', 'bar'].forEach(type => {
                        if(appState[type] && appState[type].datasets) {
                            appState[type].datasets.forEach(d => d.mode = 'manual');
                        }
                    });
                } catch (e) {
                    console.error("Dados corrompidos, resetando.");
                    appState = JSON.parse(JSON.stringify(defaultState));
                }
            } else {
                // Se vazio, criar um dataset inicial para o usuário não ver tela em branco
                addDataset('line');
                addDataset('bar');
            }
            
            // Render inicial
            renderAllDatasets();
            loadSavedList('line');
            loadSavedList('bar');
            updateStorageBar();
        }

        function updateStorageBar() {
            const dataStr = JSON.stringify(localStorage);
            const size = new Blob([dataStr]).size;
            const limit = 5 * 1024 * 1024; // 5MB padrão
            const percent = Math.min(100, (size / limit) * 100);
            
            const bar = document.getElementById('storageProgress');
            const text = document.getElementById('storageText');
            
            bar.style.width = `${percent}%`;
            if(percent > 90) bar.className = 'bg-red-500 h-2.5 rounded-full transition-all duration-500';
            else bar.className = 'bg-indigo-500 h-2.5 rounded-full transition-all duration-500';

            text.textContent = `${percent.toFixed(1)}% (${(size/1024).toFixed(0)} KB usados)`;
        }

        // --- SISTEMA DE UI / NAVEGAÇÃO ---

        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    const targetId = tab.getAttribute('data-tab') + '-tab';
                    document.getElementById(targetId).classList.add('active');
                    
                    if(tab.dataset.tab.includes('chart')) {
                        const type = tab.dataset.tab.split('-')[0]; 
                        if(chartInstances[type]) chartInstances[type].resize();
                    }
                });
            });
        }

        function showToast(msg, type = 'info') {
            const container = document.getElementById('toastContainer');
            const colors = {
                success: 'bg-emerald-100 border-emerald-400 text-emerald-800',
                error: 'bg-red-100 border-red-400 text-red-800',
                info: 'bg-indigo-100 border-indigo-400 text-indigo-800'
            };
            const icons = {
                success: 'ph-check-circle',
                error: 'ph-warning-circle',
                info: 'ph-info'
            };

            const el = document.createElement('div');
            el.className = `pointer-events-auto flex items-center gap-3 p-4 rounded-lg shadow-lg border mb-3 transform transition-all duration-300 translate-x-[-100%] opacity-0 ${colors[type]}`;
            el.innerHTML = `<i class="ph-bold ${icons[type]} text-xl"></i><span class="font-medium text-sm">${msg}</span>`;
            
            container.appendChild(el);
            requestAnimationFrame(() => el.classList.remove('translate-x-[-100%]', 'opacity-0'));
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-2');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- LÓGICA CORE (DATASETS & GRÁFICOS) ---

        function addDataset(type) {
            const id = generateId();
            const idx = appState[type].datasets.length;
            const color = VIBRANT_COLORS[idx % VIBRANT_COLORS.length];
            
            appState[type].datasets.push({
                id,
                name: `Conjunto ${idx + 1}`,
                color,
                points: [{ x: '', y: '', label: '' }],
                mode: 'manual'
            });
            
            renderDatasetCard(type, id);
            saveData();
        }

        function removeDataset(type, id) {
            appState[type].datasets = appState[type].datasets.filter(d => d.id !== id);
            renderAllDatasets(type); // Re-render lista
            saveData();
        }

        function renderAllDatasets(specificType = null) {
            const types = specificType ? [specificType] : ['line', 'bar'];
            types.forEach(type => {
                const container = document.getElementById(`${type}DatasetsList`);
                container.innerHTML = ''; // Limpa tudo
                if(appState[type] && appState[type].datasets) {
                    appState[type].datasets.forEach(ds => renderDatasetCard(type, ds.id));
                }
            });
        }

        function toggleDatasetMode(type, id) {
            const ds = appState[type].datasets.find(d => d.id === id);
            ds.mode = ds.mode === 'manual' ? 'paste' : 'manual';
            renderDatasetCard(type, id);
        }

        // Renderiza um único Card de Dataset
        function renderDatasetCard(type, id) {
            const ds = appState[type].datasets.find(d => d.id === id);
            if (!ds) return;

            const container = document.getElementById(`${type}DatasetsList`);
            let card = document.getElementById(`card-${type}-${id}`);

            // Se o card não existe no DOM, cria. Se existe, vamos substituir o conteúdo.
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${type}-${id}`;
                card.className = "card border-l-4"; // Usa a classe card do template
                card.style.borderLeftColor = ds.color;
                container.appendChild(card);
            } else {
                card.style.borderLeftColor = ds.color; // Atualiza cor se mudou
            }

            // HTML Interno do Card
            let headerHtml = `
                <div class="flex flex-wrap gap-3 items-center mb-4">
                    <!-- Nome -->
                    <input type="text" value="${ds.name}" onchange="updateName('${type}', '${id}', this.value)" 
                    class="input-std font-semibold text-slate-700 flex-grow min-w-[150px] py-1" placeholder="Nome">
                    
                    <!-- Cor -->
                    <div class="relative">
                        <button class="color-select-btn" onclick="toggleColorDropdown('${type}', '${id}')">
                            <div class="w-4 h-4 rounded-full" style="background-color: ${ds.color}"></div>
                            <i class="ph-bold ph-caret-down text-xs text-slate-400"></i>
                        </button>
                        <div id="color-dropdown-${type}-${id}" class="color-dropdown hidden">
                            ${VIBRANT_COLORS.map(c => `
                                <div class="color-option ${c === ds.color ? 'selected' : ''}" 
                                     style="background-color: ${c}" 
                                     onclick="updateColor('${type}', '${id}', '${c}')"></div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Mode Toggle -->
                    <button onclick="toggleDatasetMode('${type}', '${id}')" class="btn btn-ghost p-1 text-xs" title="Alternar entrada Manual/Colar">
                        <i class="ph-bold ${ds.mode === 'manual' ? 'ph-table' : 'ph-clipboard-text'} text-lg"></i>
                    </button>

                    <!-- Excluir -->
                    <button onclick="removeDataset('${type}', '${id}')" class="btn btn-ghost text-red-400 hover:text-red-600 p-1">
                        <i class="ph-bold ph-trash text-lg"></i>
                    </button>
                </div>
            `;

            let bodyHtml = '';

            if (ds.mode === 'manual') {
                bodyHtml = `
                    <div class="overflow-x-auto border border-slate-100 rounded-lg">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-slate-500 font-semibold">
                                <tr>
                                    ${type === 'line' ? '<th class="p-2 w-[25%]">Rótulo</th>' : ''}
                                    <th class="p-2 w-[30%]">${type === 'bar' ? 'Categoria' : 'Eixo X'}</th>
                                    <th class="p-2 w-[30%]">Valor (Y)</th>
                                    <th class="p-2 w-[5%]"></th>
                                </tr>
                            </thead>
                            <tbody id="rows-${type}-${id}">
                                <!-- Linhas geradas abaixo -->
                            </tbody>
                        </table>
                    </div>
                    <button onclick="addRow('${type}', '${id}')" class="btn btn-dashed w-full mt-2 py-1 text-xs">
                        <i class="ph-bold ph-plus"></i> Adicionar Linha
                    </button>
                `;
            } else {
                bodyHtml = `
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <p class="text-xs text-slate-500 mb-2">Cole dados do Excel/CSV. Selecione as colunas correspondentes.</p>
                        <textarea id="paste-area-${type}-${id}" class="input-std h-24 font-mono text-xs mb-3 resize-none" placeholder="10\t2.5\n20\t5.0"></textarea>
                        
                        <div class="grid grid-cols-3 gap-2 mb-3">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase">X</label>
                                <select id="map-x-${type}-${id}" class="input-std py-1 text-xs"><option value="0">Col 1</option><option value="1">Col 2</option><option value="2">Col 3</option></select>
                            </div>
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase">Y</label>
                                <select id="map-y-${type}-${id}" class="input-std py-1 text-xs"><option value="1">Col 2</option><option value="0">Col 1</option><option value="2">Col 3</option></select>
                            </div>
                             ${type === 'line' ? `
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase">Label</label>
                                <select id="map-lbl-${type}-${id}" class="input-std py-1 text-xs"><option value="-1">-</option><option value="2">Col 3</option></select>
                            </div>` : ''}
                        </div>

                        <button onclick="processPaste('${type}', '${id}')" class="btn btn-primary w-full text-xs">
                            Processar
                        </button>
                    </div>
                `;
            }

            card.innerHTML = headerHtml + bodyHtml;

            // Preenche linhas se manual
            if (ds.mode === 'manual') {
                const tbody = document.getElementById(`rows-${type}-${id}`);
                ds.points.forEach((pt, idx) => {
                    const tr = document.createElement('tr');
                    tr.className = "border-b border-slate-50 last:border-0";
                    
                    const inputLbl = type === 'line' ? 
                        `<td class="p-1"><input type="text" value="${pt.label || ''}" onchange="updatePoint('${type}', '${id}', ${idx}, 'label', this.value)" class="input-std input-compact"></td>` : '';

                    tr.innerHTML = `
                        ${inputLbl}
                        <td class="p-1"><input type="text" value="${pt.x}" onchange="updatePoint('${type}', '${id}', ${idx}, 'x', this.value)" class="input-std input-compact"></td>
                        <td class="p-1"><input type="number" step="any" value="${pt.y}" onchange="updatePoint('${type}', '${id}', ${idx}, 'y', this.value)" class="input-std input-compact"></td>
                        <td class="p-1 text-center">
                            <button onclick="removeRow('${type}', '${id}', ${idx})" class="text-slate-300 hover:text-red-500"><i class="ph-bold ph-x"></i></button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- MANIPULAÇÃO DE DADOS ---

        function updateName(type, id, val) {
            appState[type].datasets.find(d => d.id === id).name = val;
            saveData();
        }

        function updateColor(type, id, val) {
            appState[type].datasets.find(d => d.id === id).color = val;
            document.getElementById(`color-dropdown-${type}-${id}`).classList.add('hidden');
            renderDatasetCard(type, id);
            saveData();
        }

        function toggleColorDropdown(type, id) {
            const el = document.getElementById(`color-dropdown-${type}-${id}`);
            el.classList.toggle('hidden');
        }

        function addRow(type, id) {
            appState[type].datasets.find(d => d.id === id).points.push({ x: '', y: '', label: '' });
            renderDatasetCard(type, id);
        }

        function removeRow(type, id, idx) {
            appState[type].datasets.find(d => d.id === id).points.splice(idx, 1);
            renderDatasetCard(type, id);
            saveData();
        }

        function updatePoint(type, id, idx, field, val) {
            appState[type].datasets.find(d => d.id === id).points[idx][field] = val;
            saveData();
        }

        function processPaste(type, id) {
            const raw = document.getElementById(`paste-area-${type}-${id}`).value;
            const xIdx = parseFloat(document.getElementById(`map-x-${type}-${id}`).value);
            const yIdx = parseFloat(document.getElementById(`map-y-${type}-${id}`).value);
            const lIdx = type === 'line' ? parseFloat(document.getElementById(`map-lbl-${type}-${id}`).value) : -1;

            if (!raw.trim()) return showToast('Área vazia!', 'error');

            const rows = raw.trim().split('\n');
            const newPoints = [];

            rows.forEach(row => {
                const parts = row.split(/[\t,;]+/).map(s => s.trim()).filter(s => s !== '');
                if (parts.length < 2) return;

                const rawX = parts[xIdx];
                const rawY = parts[yIdx];
                
                if (rawX !== undefined && rawY !== undefined) {
                    const yVal = rawY.replace(',', '.');
                    if (!isNaN(parseFloat(yVal))) {
                        newPoints.push({
                            x: rawX,
                            y: yVal,
                            label: (lIdx !== -1 && parts[lIdx]) ? parts[lIdx] : ''
                        });
                    }
                }
            });

            if (newPoints.length > 0) {
                const ds = appState[type].datasets.find(d => d.id === id);
                ds.points = newPoints;
                ds.mode = 'manual';
                renderDatasetCard(type, id);
                showToast(`${newPoints.length} linhas importadas!`, 'success');
                saveData();
            } else {
                showToast('Falha ao processar dados.', 'error');
            }
        }

        // --- CHART.JS RENDER ---

        function renderChart(type) {
            const ctx = document.getElementById(`${type}Canvas`);
            if(!ctx) return;

            // Destrói anterior
            if (chartInstances[type]) {
                chartInstances[type].destroy();
            }

            const datasets = appState[type].datasets;
            
            if (type === 'line') {
                renderLineChart(ctx.getContext('2d'), datasets);
            } else {
                renderBarChart(ctx.getContext('2d'), datasets);
            }
            
            showToast('Gráfico atualizado!', 'success');
        }

        function renderLineChart(ctx, datasets) {
            const fill = document.getElementById('lineFillToggle').checked;
            
            // Verifica se é numérico
            let isNumericX = true;
            datasets.forEach(ds => {
                ds.points.forEach(p => {
                    if (p.x !== '' && isNaN(parseFloat(p.x.toString().replace(',','.')))) isNumericX = false;
                });
            });

            const chartDatasets = datasets.map(ds => {
                let data = ds.points.filter(p => p.x !== '' && p.y !== '').map(p => ({
                    x: isNumericX ? parseFloat(p.x.toString().replace(',','.')) : p.x,
                    y: parseFloat(p.y.toString().replace(',','.')),
                    label: p.label
                }));

                if (isNumericX) data.sort((a, b) => a.x - b.x);

                return {
                    label: ds.name,
                    data: data,
                    borderColor: ds.color,
                    backgroundColor: ds.color + '40',
                    fill: fill ? 'origin' : false,
                    tension: 0.3,
                    pointRadius: 4,
                    pointHoverRadius: 6
                };
            });

            chartInstances.line = new Chart(ctx, {
                type: 'line',
                data: { datasets: chartDatasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: isNumericX ? 'linear' : 'category',
                            grid: { color: '#f1f5f9' }
                        },
                        y: { grid: { color: '#f1f5f9' } }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    label += context.parsed.y;
                                    if (context.raw.label) label += ` (${context.raw.label})`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });

            // Integral
            const legendDiv = document.getElementById('lineAreaLegend');
            const legendContent = document.getElementById('lineAreaLegendContent');
            
            if(fill && isNumericX) {
                legendDiv.classList.remove('hidden');
                let html = '';
                chartDatasets.forEach(ds => {
                    let area = 0;
                    const pts = ds.data;
                    for(let i=0; i<pts.length-1; i++) {
                        const h = pts[i+1].x - pts[i].x;
                        const avgH = (pts[i].y + pts[i+1].y) / 2;
                        area += avgH * h;
                    }
                    html += `
                        <div class="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-100">
                            <div class="w-2 h-2 rounded-full" style="background:${ds.borderColor}"></div>
                            <span class="text-slate-500 font-medium">${ds.label}:</span>
                            <strong class="text-slate-800">${formatNum(area)}</strong>
                        </div>`;
                });
                legendContent.innerHTML = html;
            } else {
                legendDiv.classList.add('hidden');
            }
        }

        function renderBarChart(ctx, datasets) {
            const stacked = document.getElementById('barStackToggle').checked;

            const allLabels = new Set();
            datasets.forEach(ds => ds.points.forEach(p => { if (p.x) allLabels.add(p.x); }));
            const labelsArray = Array.from(allLabels).sort();

            const chartDatasets = datasets.map(ds => {
                const data = labelsArray.map(lbl => {
                    const pt = ds.points.find(p => p.x == lbl);
                    return pt ? parseFloat(pt.y.replace(',','.')) : 0;
                });

                return {
                    label: ds.name,
                    data: data,
                    backgroundColor: ds.color,
                    borderRadius: 4,
                    borderWidth: stacked ? 1 : 0,
                    borderColor: 'white'
                };
            });

            chartInstances.bar = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labelsArray,
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { stacked: stacked, grid: { display: false } },
                        y: { stacked: stacked, grid: { color: '#f1f5f9' } }
                    }
                }
            });
        }

        // --- SISTEMA DE BIBLIOTECA LOCAL ---

        function saveChart(type) {
            const title = document.getElementById(`${type}ChartTitle`).value.trim();
            if (!title) return showToast('Digite um nome para salvar', 'error');

            const key = `dataplotter_lib_${type}`;
            const lib = JSON.parse(localStorage.getItem(key) || '{}');
            
            lib[title] = {
                date: new Date().toISOString(),
                datasets: appState[type].datasets
            };

            localStorage.setItem(key, JSON.stringify(lib));
            loadSavedList(type);
            updateStorageBar();
            showToast('Salvo na biblioteca!', 'success');
        }

        function loadSavedList(type) {
            const key = `dataplotter_lib_${type}`;
            const lib = JSON.parse(localStorage.getItem(key) || '{}');
            const sel = document.getElementById(`${type}SavedSelect`);
            
            sel.innerHTML = '<option value="">Selecione...</option>';
            Object.keys(lib).forEach(k => {
                sel.innerHTML += `<option value="${k}">${k}</option>`;
            });
        }

        function loadChart(type) {
            const title = document.getElementById(`${type}SavedSelect`).value;
            if (!title) return;

            const key = `dataplotter_lib_${type}`;
            const lib = JSON.parse(localStorage.getItem(key) || '{}');
            
            if (lib[title]) {
                appState[type].datasets = lib[title].datasets;
                appState[type].datasets.forEach(d => d.mode = 'manual'); // Força visualização normal
                renderAllDatasets(type);
                renderChart(type);
                document.getElementById(`${type}ChartTitle`).value = title;
                showToast('Gráfico carregado!', 'success');
                saveData(); // Atualiza estado atual
            }
        }

        function deleteSavedChart(type) {
            const title = document.getElementById(`${type}SavedSelect`).value;
            if (!title) return;
            
            if(confirm(`Excluir "${title}" da biblioteca?`)) {
                const key = `dataplotter_lib_${type}`;
                const lib = JSON.parse(localStorage.getItem(key) || '{}');
                delete lib[title];
                localStorage.setItem(key, JSON.stringify(lib));
                loadSavedList(type);
                updateStorageBar();
                showToast('Item excluído', 'info');
            }
        }

        function clearAll(type) {
            if(confirm('Isso limpará os dados da tela atual. Confirmar?')) {
                appState[type].datasets = [];
                addDataset(type); // Adiciona um novo vazio
                renderChart(type); // Limpa o canvas
                saveData();
                showToast('Tela limpa.', 'success');
            }
        }

        // --- EXPORT/IMPORT GLOBAL (Config Tab) ---
        
        document.getElementById('btnExport').addEventListener('click', () => {
            const dataStr = JSON.stringify(appState, null, 2);
            navigator.clipboard.writeText(dataStr).then(() => {
                showToast('Copiado para a área de transferência!', 'success');
            }).catch(() => {
                const area = document.getElementById('importArea');
                area.value = dataStr;
                area.select();
                document.execCommand('copy');
                area.value = '';
                showToast('Copiado (via fallback)!', 'success');
            });
        });

        document.getElementById('btnImport').addEventListener('click', () => {
            const str = document.getElementById('importArea').value.trim();
            if(!str) return showToast('Cole o código primeiro.', 'error');

            try {
                const parsed = JSON.parse(str);
                if(confirm('Isso substituirá TODOS os dados atuais. Continuar?')) {
                    appState = parsed;
                    saveData();
                    renderAllDatasets();
                    loadSavedList('line'); // Recarrega listas pois pode ter afetado
                    loadSavedList('bar');
                    showToast('Dados importados!', 'success');
                    document.getElementById('importArea').value = '';
                }
            } catch (e) {
                showToast('JSON Inválido.', 'error');
            }
        });

        // --- INICIALIZAÇÃO ---

        document.addEventListener('DOMContentLoaded', () => {
            initTabs();
            loadData();
            
            // Renderiza gráficos iniciais vazios ou com dados carregados
            setTimeout(() => {
                renderChart('line');
                renderChart('bar');
            }, 100);
        });

    </script>
</body>
</html>