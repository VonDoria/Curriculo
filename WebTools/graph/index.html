<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataPlotter</title>
    <meta name="theme-color" content="#f8fafc">
    <link rel="icon" href="graphLogo.png">
    
    <!-- Dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Slate-50 */
            color: #334155; /* Slate-700 */
        }

        /* --- UI COMPONENTS --- */
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
            overflow: hidden; /* Importante para o collapse */
        }

        .input-std {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            outline: none;
            transition: border-color 0.2s;
            font-size: 0.875rem;
            background-color: #fff;
        }
        .input-std:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            border: none;
        }
        
        .btn-primary { background-color: #6366f1; color: white; }
        .btn-primary:hover { background-color: #4f46e5; }
        
        .btn-secondary { background-color: #f1f5f9; color: #475569; }
        .btn-secondary:hover { background-color: #e2e8f0; }

        .btn-ghost { background-color: transparent; color: #64748b; }
        .btn-ghost:hover { background-color: #f1f5f9; color: #334155; }

        .btn-dashed {
            background-color: #f8fafc;
            border: 2px dashed #cbd5e1;
            color: #64748b;
        }
        .btn-dashed:hover {
            border-color: #6366f1;
            color: #6366f1;
            background-color: #eef2ff;
        }

        /* --- DRAG AND DROP STYLES --- */
        .draggable-source {
            opacity: 0.4;
            border: 2px dashed #6366f1;
        }
        .drag-handle {
            cursor: grab;
            color: #94a3b8;
        }
        .drag-handle:active {
            cursor: grabbing;
            color: #6366f1;
        }

        /* --- COLOR PICKER --- */
        .color-circle {
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.1s;
        }
        .color-circle:hover { transform: scale(1.1); }
        .color-circle.selected { border-color: #334155; transform: scale(1.1); }

        /* --- COLLAPSIBLE ANIMATION --- */
        .card-body {
            max-height: 2000px; /* Valor arbitrário alto */
            opacity: 1;
            transition: all 0.3s ease-in-out;
            padding: 1rem;
            border-top: 1px solid #f1f5f9;
        }
        .card-body.collapsed {
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
            opacity: 0;
            overflow: hidden;
            border-top: none;
        }
        .chevron-icon { transition: transform 0.3s; }
        .chevron-icon.rotated { transform: rotate(-180deg); }

    </style>
</head>
<body class="antialiased pb-20 flex justify-center">

    <div class="container p-4 grid grid-cols-1 md:grid-cols-5 gap-4">
        
        <!-- ÁREA DO GRÁFICO (FIXO) -->
        <section class="card p-4 shadow-lg ring-1 ring-slate-900/5 md:col-span-4 max-h-[100vh]">
            <div class="h-[350px] md:h-[80vh] w-full relative">
                <canvas id="mainCanvas"></canvas>
            </div>
            <div class="mt-4 flex justify-between items-center border-t border-slate-100 pt-3">
                <span class="text-xs font-semibold text-slate-400 uppercase tracking-wider">Visualização</span>
                <button onclick="renderChart()" class="btn btn-primary text-xs shadow-md shadow-indigo-200">
                    <i class="ph-bold ph-arrows-clockwise"></i> Atualizar Gráfico
                </button>
            </div>
        </section>

        <!-- LISTA DE DATASETS (DRAGGABLE) -->
        <section class="space-y-4">
            <div class="flex justify-between items-end px-1">
                <h2 class="text-sm font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2">
                    <i class="ph-bold ph-database"></i> Conjuntos de Dados
                </h2>
            </div>
            
            <div id="datasetsContainer" class="space-y-3">
                <!-- Cards injetados via JS -->
            </div>

            <button onclick="addNewDataset()" class="btn btn-dashed w-full py-4 text-slate-500 hover:text-indigo-600 transition-colors">
                <i class="ph-bold ph-plus-circle text-xl"></i> Adicionar Novo Conjunto
            </button>
        </section>

        <!-- RODAPÉ DE UTILITÁRIOS -->
        <footer class="grid grid-cols-1 md:grid-cols-2 gap-6 border-slate-200 mt-4 md:col-span-5">
            
            <!-- Biblioteca Local -->
            <div class="card p-4 bg-slate-50 border-slate-200">
                <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                    <i class="ph-bold ph-floppy-disk text-slate-500"></i> Biblioteca Local
                </h3>
                <div class="space-y-3">
                    <div class="flex gap-2">
                        <input type="text" id="saveTitle" class="input-std" placeholder="Nome do salvamento...">
                        <button onclick="saveToLibrary()" class="btn btn-secondary whitespace-nowrap">Salvar</button>
                    </div>
                    <div class="flex gap-2">
                        <select id="loadSelect" class="input-std">
                            <option value="">Selecione para carregar...</option>
                        </select>
                        <button onclick="loadFromLibrary()" class="btn btn-primary">Carregar</button>
                        <button onclick="deleteFromLibrary()" class="btn btn-ghost text-red-500 hover:text-red-700 px-2"><i class="ph-bold ph-trash"></i></button>
                    </div>
                </div>
            </div>

            <!-- Dados & Armazenamento -->
            <div class="card p-4 bg-slate-50 border-slate-200 flex flex-col justify-between">
                <div>
                    <h3 class="text-sm font-bold text-slate-700 mb-3 flex items-center gap-2">
                        <i class="ph-bold ph-arrows-left-right text-slate-500"></i> Importar / Exportar
                    </h3>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button onclick="exportData()" class="btn btn-secondary text-xs">
                            <i class="ph-bold ph-copy"></i> Copiar Dados
                        </button>
                        <button onclick="importData()" class="btn btn-secondary text-xs">
                            <i class="ph-bold ph-download-simple"></i> Colar Dados
                        </button>
                    </div>
                </div>
                
                <!-- Storage Bar -->
                <div>
                    <div class="w-full bg-slate-200 rounded-full h-1.5 overflow-hidden mb-1">
                        <div id="storageProgress" class="bg-indigo-500 h-1.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-slate-400">
                        <span>Armazenamento Local</span>
                        <span id="storageText">0%</span>
                    </div>
                </div>
            </div>
            
            <div class="md:col-span-2 text-center">
                 <button onclick="clearAll()" class="text-xs text-red-400 hover:text-red-600 font-medium inline-flex items-center gap-1">
                    <i class="ph-bold ph-trash"></i> Resetar Tudo
                </button>
            </div>
        </footer>

    </div>

    <!-- Toast Container -->
    <div id="toastContainer" class="fixed bottom-5 left-1/2 transform -translate-x-1/2 z-50 flex flex-col gap-2 pointer-events-none w-full max-w-sm px-4"></div>

    <!-- Import Modal (Hidden) -->
    <dialog id="importModal" class="p-0 rounded-lg shadow-2xl backdrop:bg-slate-900/50 border border-slate-200 w-full max-w-md">
        <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
            <h3 class="font-bold text-slate-700">Importar JSON</h3>
            <button onclick="document.getElementById('importModal').close()" class="text-slate-400 hover:text-slate-600"><i class="ph-bold ph-x"></i></button>
        </div>
        <div class="p-4">
            <textarea id="importTextarea" class="input-std h-32 font-mono text-xs resize-none mb-3" placeholder="Cole o código JSON aqui..."></textarea>
            <button onclick="processImport()" class="btn btn-primary w-full">Importar e Substituir</button>
        </div>
    </dialog>

    <script>
        /**
         * GLOBAL CONFIG & UTILS
         */
        const APP_KEY = 'DataPlotter_V2_Store'; 
        const LIB_KEY = 'DataPlotter_V2_Lib';
        const VIBRANT_COLORS = ['#6366f1', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#3b82f6', '#f43f5e'];
        const generateId = () => Math.random().toString(36).substr(2, 9);

        // Estado Unificado
        let appState = {
            datasets: []
        };
        
        let chartInstance = null;
        let draggedItemIndex = null;

        // --- CORE: STATE MANAGEMENT ---

        function saveData() {
            try {
                localStorage.setItem(APP_KEY, JSON.stringify(appState));
                updateStorageBar();
            } catch (e) {
                showToast('Erro ao salvar. Armazenamento cheio?', 'error');
            }
        }

        function loadData() {
            const raw = localStorage.getItem(APP_KEY);
            
            // Tentativa de Migração da V1 para V2
            if (!raw) {
                const v1Data = localStorage.getItem('DataPlotter_V2_Store'); // V1 key was the same in prompt but struct diff
                // Se a estrutura antiga for detectada (com 'line' e 'bar' na raiz)
                if (raw && (JSON.parse(raw).line || JSON.parse(raw).bar)) {
                   // Apenas limpamos para evitar conflito na V2
                   // O código abaixo assume "fresh start" se não achar a estrutura correta
                } else {
                    // Start Fresh
                    addNewDataset(); 
                }
            } else {
                try {
                    const parsed = JSON.parse(raw);
                    // Validação simples da estrutura V2
                    if(Array.isArray(parsed.datasets)) {
                        appState = parsed;
                    } else {
                        // Migração ou Reset
                        appState = { datasets: [] };
                        addNewDataset();
                    }
                } catch (e) {
                    appState = { datasets: [] };
                    addNewDataset();
                }
            }
            renderDatasetsList();
            renderChart();
            updateLibraryList();
            updateStorageBar();
        }

        // --- DATASET LOGIC ---

        function addNewDataset() {
            const idx = appState.datasets.length;
            const color = VIBRANT_COLORS[idx % VIBRANT_COLORS.length];
            
            const newDs = {
                id: generateId(),
                name: `Conjunto ${idx + 1}`,
                type: 'line', // line, bar, scatter
                color: color,
                mode: 'manual', // manual vs paste
                collapsed: false,
                points: [{ x: '', y: '', label: '' }]
            };
            
            appState.datasets.push(newDs);
            renderDatasetsList();
            saveData();
        }

        function removeDataset(id) {
            appState.datasets = appState.datasets.filter(d => d.id !== id);
            renderDatasetsList();
            renderChart(); // Atualiza gráfico ao remover
            saveData();
        }

        function toggleCollapse(id) {
            const ds = appState.datasets.find(d => d.id === id);
            ds.collapsed = !ds.collapsed;
            
            // UI Update Only (sem re-renderizar tudo para performance)
            const body = document.getElementById(`body-${id}`);
            const icon = document.getElementById(`chevron-${id}`);
            
            if(ds.collapsed) {
                body.classList.add('collapsed');
                icon.classList.add('rotated'); // Icon down
            } else {
                body.classList.remove('collapsed');
                icon.classList.remove('rotated'); // Icon up
            }
            saveData();
        }

        function updateDatasetField(id, field, value) {
            const ds = appState.datasets.find(d => d.id === id);
            ds[field] = value;
            if(field === 'name' || field === 'type' || field === 'color') {
                // Se mudar cor/tipo, atualiza o header visualmente se necessário
                if(field === 'color') document.getElementById(`color-indicator-${id}`).style.backgroundColor = value;
            }
            saveData();
        }

        // --- DRAG AND DROP LOGIC ---

        function handleDragStart(e, index) {
            draggedItemIndex = index;
            e.dataTransfer.effectAllowed = 'move';
            e.target.closest('.card').classList.add('opacity-50');
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDrop(e, index) {
            e.preventDefault();
            const cards = document.querySelectorAll('.card-dataset');
            cards.forEach(c => c.classList.remove('opacity-50'));

            if (draggedItemIndex === index) return;

            // Reorder array
            const itemToMove = appState.datasets[draggedItemIndex];
            appState.datasets.splice(draggedItemIndex, 1);
            appState.datasets.splice(index, 0, itemToMove);

            draggedItemIndex = null;
            renderDatasetsList();
            saveData(); // Salva nova ordem
        }

        function handleDragEnd(e) {
            const cards = document.querySelectorAll('.card-dataset');
            cards.forEach(c => c.classList.remove('opacity-50'));
        }

        // --- RENDER UI: CARD COMPONENT ---

        function renderDatasetsList() {
            const container = document.getElementById('datasetsContainer');
            container.innerHTML = '';

            appState.datasets.forEach((ds, index) => {
                const el = document.createElement('div');
                el.className = 'card card-dataset group';
                el.draggable = true;
                el.ondragstart = (e) => handleDragStart(e, index);
                el.ondragover = handleDragOver;
                el.ondrop = (e) => handleDrop(e, index);
                el.ondragend = handleDragEnd;

                // Header
                const header = `
                    <div class="flex items-center gap-3 p-2 bg-white cursor-pointer select-none" >
                        <!-- Drag Handle -->
                        <div class="drag-handle p-1 hover:bg-slate-100 rounded" title="Arraste para reordenar">
                            <i class="ph-bold ph-dots-six-vertical text-lg"></i>
                        </div>

                        <!-- Color Indicator & Picker Trigger -->
                        <div class="relative group/color">
                            <div id="color-indicator-${ds.id}" class="w-5 h-5 rounded-full shadow-sm ring-1 ring-slate-200 transition-transform hover:scale-110" 
                                 style="background-color: ${ds.color}"
                                 onclick="document.getElementById('cp-${ds.id}').classList.toggle('hidden')"></div>
                            
                            <!-- Dropdown Cor -->
                            <div id="cp-${ds.id}" class="hidden absolute top-full left-0 mt-2 p-2 bg-white border border-slate-200 shadow-xl rounded-lg grid grid-cols-5 gap-1 z-10 w-[140px]">
                                ${VIBRANT_COLORS.map(c => `
                                    <div class="w-5 h-5 rounded-full cursor-pointer hover:scale-110 border border-transparent hover:border-slate-400" 
                                         style="background-color: ${c}"
                                         onclick="updateDatasetField('${ds.id}', 'color', '${c}'); document.getElementById('cp-${ds.id}').classList.add('hidden'); renderChart();">
                                    </div>
                                `).join('')}
                            </div>
                        </div>

                        <!-- Main Controls (Collapsed View) -->
                        <div class="flex-grow flex flex-wrap gap-2 items-center">
                            <input type="text" value="${ds.name}" 
                                   onchange="updateDatasetField('${ds.id}', 'name', this.value); renderChart();"
                                   onclick="event.stopPropagation()"
                                   class="font-semibold text-slate-700 bg-transparent border-none outline-none focus:bg-slate-50 hover:bg-slate-50 rounded px-2 py-1 transition-colors w-full flex-grow" 
                                   placeholder="Nome do Conjunto">
                            
                            <select onchange="updateDatasetField('${ds.id}', 'type', this.value); renderChart();" 
                                    onclick="event.stopPropagation()"
                                    class="text-xs font-medium text-slate-500 bg-slate-50 border border-slate-200 rounded px-2 py-1 outline-none focus:border-indigo-500 cursor-pointer">
                                <option value="line" ${ds.type === 'line' ? 'selected' : ''}>Linha</option>
                                <option value="bar" ${ds.type === 'bar' ? 'selected' : ''}>Barras</option>
                                <option value="scatter" ${ds.type === 'scatter' ? 'selected' : ''}>Pontos</option>
                            </select>
                        </div>

                        <!-- Collapse Trigger -->
                        <button onclick="toggleCollapse('${ds.id}')" class="p-2 text-slate-400 hover:text-indigo-600 transition-colors">
                            <i id="chevron-${ds.id}" class="ph-bold ph-caret-up chevron-icon ${ds.collapsed ? 'rotated' : ''}"></i>
                        </button>
                    </div>
                `;

                // Body (Data Entry)
                const body = `
                    <div id="body-${ds.id}" class="card-body ${ds.collapsed ? 'collapsed' : ''} bg-slate-50/50">
                        <div class="flex justify-between items-center mb-3">
                            <div class="flex gap-2">
                                <button onclick="setMode('${ds.id}', 'manual')" class="text-xs px-2 py-1 rounded ${ds.mode === 'manual' ? 'bg-indigo-100 text-indigo-700 font-bold' : 'text-slate-500 hover:bg-slate-100'}">Tabela</button>
                                <button onclick="setMode('${ds.id}', 'paste')" class="text-xs px-2 py-1 rounded ${ds.mode === 'paste' ? 'bg-indigo-100 text-indigo-700 font-bold' : 'text-slate-500 hover:bg-slate-100'}">Colar (Excel)</button>
                            </div>
                            <button onclick="removeDataset('${ds.id}')" class="text-xs text-red-400 hover:text-red-600 flex items-center gap-1">
                                <i class="ph-bold ph-trash"></i> Excluir Conjunto
                            </button>
                        </div>

                        ${ds.mode === 'manual' ? renderTable(ds) : renderPaste(ds)}
                    </div>
                `;

                el.innerHTML = header + body;
                container.appendChild(el);
            });
        }

        function setMode(id, mode) {
            updateDatasetField(id, 'mode', mode);
            renderDatasetsList();
        }

        function renderTable(ds) {
            const rows = ds.points.map((pt, idx) => `
                <div class="flex gap-2 mb-2 items-center">
                    <input type="text" placeholder="X" value="${pt.x}" onchange="updatePoint('${ds.id}', ${idx}, 'x', this.value)" class="input-std text-xs w-1/3">
                    <input type="text" placeholder="Y" step="any" value="${pt.y}" onchange="updatePoint('${ds.id}', ${idx}, 'y', this.value)" class="input-std text-xs w-1/3">
                    <input type="text" placeholder="Rótulo (Op)" value="${pt.label || ''}" onchange="updatePoint('${ds.id}', ${idx}, 'label', this.value)" class="input-std text-xs w-1/3">
                    <button onclick="removePoint('${ds.id}', ${idx})" class="text-slate-300 hover:text-red-500 px-1"><i class="ph-bold ph-x"></i></button>
                </div>
            `).join('');

            return `
                <div>
                    <div class="flex gap-2 mb-1 text-[10px] font-bold text-slate-400 uppercase px-1">
                        <span class="w-1/3">Eixo X</span>
                        <span class="w-1/3">Eixo Y</span>
                        <span class="w-1/3">Rótulo</span>
                        <span class="w-6"></span>
                    </div>
                    ${rows}
                    <button onclick="addPoint('${ds.id}')" class="btn btn-dashed w-full py-1 text-xs mt-2"><i class="ph-bold ph-plus"></i> Adicionar Linha</button>
                </div>
            `;
        }

        function renderPaste(ds) {
            return `
                <div>
                    <textarea id="paste-${ds.id}" class="input-std h-24 font-mono text-xs mb-2 resize-none" placeholder="Cole seus dados aqui (Tab ou CSV)..."></textarea>
                    <div class="grid grid-cols-3 gap-2 mb-2">
                        <div><label class="text-[10px] uppercase font-bold text-slate-400">Col X</label><select id="mx-${ds.id}" class="input-std py-1 text-xs"><option value="0">1ª</option><option value="1">2ª</option><option value="2">3ª</option></select></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-400">Col Y</label><select id="my-${ds.id}" class="input-std py-1 text-xs"><option value="1">2ª</option><option value="0">1ª</option><option value="2">3ª</option></select></div>
                        <div><label class="text-[10px] uppercase font-bold text-slate-400">Rótulo</label><select id="ml-${ds.id}" class="input-std py-1 text-xs"><option value="-1">Nenhum</option><option value="2">3ª</option><option value="0">1ª</option></select></div>
                    </div>
                    <button onclick="processPaste('${ds.id}')" class="btn btn-primary w-full text-xs">Processar Dados</button>
                </div>
            `;
        }

        // --- POINT DATA LOGIC ---

        function addPoint(id) {
            const ds = appState.datasets.find(d => d.id === id);
            ds.points.push({ x: '', y: '', label: '' });
            renderDatasetsList();
        }

        function removePoint(id, idx) {
            const ds = appState.datasets.find(d => d.id === id);
            ds.points.splice(idx, 1);
            saveData();
            renderDatasetsList();
        }

        function updatePoint(id, idx, field, val) {
            const ds = appState.datasets.find(d => d.id === id);
            ds.points[idx][field] = val;
            saveData();
        }

        function processPaste(id) {
            const raw = document.getElementById(`paste-${id}`).value;
            const xIdx = parseInt(document.getElementById(`mx-${id}`).value);
            const yIdx = parseInt(document.getElementById(`my-${id}`).value);
            const lIdx = parseInt(document.getElementById(`ml-${id}`).value);

            if (!raw.trim()) return showToast('Área vazia!', 'error');
            
            const rows = raw.trim().split('\n');
            const newPoints = [];

            rows.forEach(row => {
                const parts = row.split(/[\t,;]+/).map(s => s.trim()).filter(s => s !== '');
                if (parts.length < 2 && lIdx === -1) return; // Minimo 2 colunas se nao tiver label explicito

                const rawX = parts[xIdx];
                const rawY = parts[yIdx];
                
                if (rawX !== undefined && rawY !== undefined) {
                    const yVal = rawY.replace(',', '.');
                    if (!isNaN(parseFloat(yVal))) {
                        newPoints.push({
                            x: rawX,
                            y: yVal,
                            label: (lIdx !== -1 && parts[lIdx]) ? parts[lIdx] : ''
                        });
                    }
                }
            });

            if (newPoints.length > 0) {
                const ds = appState.datasets.find(d => d.id === id);
                ds.points = newPoints;
                ds.mode = 'manual';
                saveData();
                renderDatasetsList();
                renderChart();
                showToast(`${newPoints.length} pontos importados!`, 'success');
            } else {
                showToast('Formato não reconhecido.', 'error');
            }
        }

        // --- CHART.JS RENDERING (HÍBRIDO) ---

        function renderChart() {
            const ctx = document.getElementById('mainCanvas');
            if (!ctx) return;

            if (chartInstance) chartInstance.destroy();

            // 1. Detectar tipo de escala X (Linear ou Categoria)
            // Se TODOS os valores X de TODOS os datasets forem numéricos, usamos linear.
            // Caso contrário, usamos Categoria (strings).
            let allNumericX = true;
            const allXValues = new Set();

            appState.datasets.forEach(ds => {
                ds.points.forEach(p => {
                    if (p.x !== '' && p.x !== null) {
                        const val = p.x.toString().replace(',', '.');
                        if (isNaN(parseFloat(val))) allNumericX = false;
                        allXValues.add(p.x);
                    }
                });
            });

            // Ordenar labels se for linear para o gráfico desenhar na ordem certa
            let labels = Array.from(allXValues);
            if (allNumericX) {
                labels.sort((a, b) => parseFloat(a.toString().replace(',','.')) - parseFloat(b.toString().replace(',','.')));
            } else {
                labels.sort();
            }

            // 2. Montar Datasets do Chart.js
            const chartDatasets = appState.datasets.map(ds => {
                // Filtrar e preparar pontos
                let data = [];
                
                if (allNumericX) {
                    // Modo XY (Scatter/Line Numeric)
                    data = ds.points
                        .filter(p => p.x !== '' && p.y !== '')
                        .map(p => ({
                            x: parseFloat(p.x.toString().replace(',', '.')),
                            y: parseFloat(p.y.toString().replace(',', '.')),
                            label: p.label
                        }))
                        .sort((a, b) => a.x - b.x);
                } else {
                    // Modo Categoria (Mapear Y para o Label X correspondente)
                    data = labels.map(lbl => {
                        const pt = ds.points.find(p => p.x == lbl);
                        return pt ? parseFloat(pt.y.toString().replace(',', '.')) : null; // null quebra a linha, 0 desenha no chão
                    });
                }

                // Configuração baseada no Tipo
                const common = {
                    label: ds.name,
                    data: data,
                    backgroundColor: ds.type === 'bar' ? ds.color : ds.color, // Pontos/Linhas usam backgroundColor para a legenda
                    borderColor: ds.color,
                };

                if (ds.type === 'line') {
                    return {
                        ...common,
                        type: 'line',
                        borderWidth: 2,
                        tension: 0.3,
                        pointRadius: 4,
                        fill: false
                    };
                } else if (ds.type === 'bar') {
                    return {
                        ...common,
                        type: 'bar',
                        backgroundColor: ds.color + 'CC', // Levemente transparente
                        borderWidth: 0,
                        barPercentage: 0.6
                    };
                } else if (ds.type === 'scatter') {
                    return {
                        ...common,
                        type: 'scatter', // Chart.js scatter é basicamente line sem linha
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        showLine: false // Garante que não desenhe linha
                    };
                }
            });

            // 3. Criar Gráfico
            chartInstance = new Chart(ctx, {
                type: 'line', // Tipo padrão base para misto
                data: {
                    labels: allNumericX ? labels : labels, // Labels usados se categoria
                    datasets: chartDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            type: allNumericX ? 'linear' : 'category',
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: { color: '#94a3b8' }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: { family: "'Inter', sans-serif", size: 12 }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += context.parsed.y;
                                    // Hack para pegar label customizado no scatter
                                    const raw = context.raw;
                                    if (raw && raw.label) label += ` (${raw.label})`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- LIBRARY & UTILS ---

        function updateStorageBar() {
            const dataStr = JSON.stringify(localStorage);
            const size = new Blob([dataStr]).size;
            const limit = 5 * 1024 * 1024; // 5MB aprox
            const percent = Math.min(100, (size / limit) * 100);
            
            const bar = document.getElementById('storageProgress');
            bar.style.width = `${percent}%`;
            bar.className = percent > 90 ? 'bg-red-500 h-1.5 rounded-full' : 'bg-indigo-500 h-1.5 rounded-full';
            document.getElementById('storageText').textContent = `${percent.toFixed(1)}% usado (${(size/1024).toFixed(0)} KB)`;
        }

        function saveToLibrary() {
            const title = document.getElementById('saveTitle').value.trim();
            if(!title) return showToast('Digite um nome.', 'error');
            
            const lib = JSON.parse(localStorage.getItem(LIB_KEY) || '{}');
            lib[title] = appState.datasets;
            localStorage.setItem(LIB_KEY, JSON.stringify(lib));
            
            updateLibraryList();
            showToast('Salvo na biblioteca!', 'success');
        }

        function updateLibraryList() {
            const lib = JSON.parse(localStorage.getItem(LIB_KEY) || '{}');
            const sel = document.getElementById('loadSelect');
            sel.innerHTML = '<option value="">Selecione...</option>';
            Object.keys(lib).forEach(k => {
                sel.innerHTML += `<option value="${k}">${k}</option>`;
            });
        }

        function loadFromLibrary() {
            const title = document.getElementById('loadSelect').value;
            if(!title) return;
            
            const lib = JSON.parse(localStorage.getItem(LIB_KEY) || '{}');
            if(lib[title]) {
                appState.datasets = lib[title];
                // Reset collapse/modes para visualização limpa
                appState.datasets.forEach(d => {
                    d.collapsed = true;
                    d.mode = 'manual';
                });
                renderDatasetsList();
                renderChart();
                saveData();
                showToast('Carregado com sucesso.', 'success');
            }
        }

        function deleteFromLibrary() {
            const title = document.getElementById('loadSelect').value;
            if(!title) return;
            if(confirm(`Excluir "${title}"?`)) {
                const lib = JSON.parse(localStorage.getItem(LIB_KEY) || '{}');
                delete lib[title];
                localStorage.setItem(LIB_KEY, JSON.stringify(lib));
                updateLibraryList();
                showToast('Item excluído.', 'success');
            }
        }

        function exportData() {
            const str = JSON.stringify(appState, null, 2);
            navigator.clipboard.writeText(str)
                .then(() => showToast('JSON copiado!', 'success'))
                .catch(() => showToast('Erro ao copiar.', 'error'));
        }

        function importData() {
            document.getElementById('importModal').showModal();
        }

        function processImport() {
            try {
                const json = JSON.parse(document.getElementById('importTextarea').value);
                if(json.datasets && Array.isArray(json.datasets)) {
                    appState = json;
                    saveData();
                    renderDatasetsList();
                    renderChart();
                    document.getElementById('importModal').close();
                    document.getElementById('importTextarea').value = '';
                    showToast('Importado com sucesso!', 'success');
                } else {
                    throw new Error('Formato inválido');
                }
            } catch(e) {
                showToast('JSON Inválido.', 'error');
            }
        }

        function clearAll() {
            if(confirm('Isso apagará todos os gráficos da tela. Continuar?')) {
                appState.datasets = [];
                addNewDataset();
                showToast('Resetado.', 'success');
            }
        }

        function showToast(msg, type) {
            const el = document.createElement('div');
            const colors = type === 'success' ? 'bg-emerald-100 text-emerald-800 border-emerald-300' : 'bg-red-100 text-red-800 border-red-300';
            el.className = `p-3 rounded-lg shadow-lg border text-sm font-medium flex items-center gap-2 transform transition-all duration-300 translate-y-10 opacity-0 ${colors}`;
            el.innerHTML = `<i class="ph-bold ${type === 'success' ? 'ph-check-circle' : 'ph-warning-circle'}"></i> ${msg}`;
            
            document.getElementById('toastContainer').appendChild(el);
            
            requestAnimationFrame(() => el.classList.remove('translate-y-10', 'opacity-0'));
            setTimeout(() => {
                el.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => el.remove(), 300);
            }, 3000);
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            // Prevenir drag de fechar collapse acidentalmente
            document.addEventListener('dragstart', (e) => {
                if(e.target.classList.contains('drag-handle')) {
                    // OK
                }
            });
        });

    </script>
</body>
</html>